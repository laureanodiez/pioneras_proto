<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiencia Interactiva AR</title>
    <!-- A-Frame y AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; sourceWidth: 1280; sourceHeight: 720; displayWidth: 800; displayHeight: 600;">
        <!-- Nieve/ventisca en todo el entorno -->
        <a-entity particle-system="preset: snow; particleCount: 3000; color: #ffffff" position="0 0 0" id="snow"></a-entity>

        <!-- Marcador -->
        <a-marker type="pattern" url="markers/pattern-pionera1.patt" id="marker">
            <!-- Recuadro 3D flotante con preguntas -->
            <a-box id="question-box" position="0 1.5 -2" depth="0.1" height="1" width="2" color="#333333" material="opacity: 0.8;" visible="false">
                <a-text id="question-text" value="Pregunta aquí" position="0 0.3 0.1" align="center" color="white" width="1.8"></a-text>
                <a-plane id="answer-1" color="#FF5733" height="0.3" width="1.8" position="0 0 0.1" text="value: Respuesta 1; align: center; color: white;" class="clickable"></a-plane>
                <a-plane id="answer-2" color="#FF5733" height="0.3" width="1.8" position="0 -0.4 0.1" text="value: Respuesta 2; align: center; color: white;" class="clickable"></a-plane>
            </a-box>

            <!-- Estampilla oculta -->
            <a-image id="stamp" src="assets/decor/pionera1.png" position="0 1.5 -2" visible="false" 
                     animation__show="property: position; to: 0 1.5 -2; dur: 1000; startEvents: show-stamp"
                     animation__fly="property: position; to: -1 3 -2; dur: 2000; startEvents: fly-stamp"></a-image>
        </a-marker>

        <!-- Cámara -->
        <a-entity camera></a-entity>
    </a-scene>

    <audio id="wind-sound" src="assets/sounds/snow-sound.mp3" loop></audio>

    <script>
        // Variables y lógica principal
        const questions = [
            { question: "¿Cuál es la capital de Francia?", answers: ["París", "Roma"], correct: 0 },
            { question: "¿Qué planeta es conocido como el Planeta Rojo?", answers: ["Marte", "Venus"], correct: 0 },
            { question: "¿Cuántos continentes hay en el mundo?", answers: ["5", "7"], correct: 1 },
            { question: "¿Cuál es el océano más grande?", answers: ["Atlántico", "Pacífico"], correct: 1 },
            { question: "¿En qué país está la Torre de Pisa?", answers: ["Italia", "España"], correct: 0 }
        ];

        let currentQuestion = 0;
        const questionText = document.getElementById('question-text');
        const answer1 = document.getElementById('answer-1');
        const answer2 = document.getElementById('answer-2');
        const stamp = document.getElementById('stamp');
        const snow = document.getElementById('snow');
        const windSound = document.getElementById('wind-sound');
        const questionBox = document.getElementById('question-box');

        // Función para el fade-in del sonido
        function fadeInAudio(audio, duration) {
            audio.play();
            let volume = 0;
            audio.volume = volume;
            const step = 1 / (duration / 100); // Incremento del volumen
            const interval = setInterval(() => {
                volume = Math.min(volume + step, 1);
                audio.volume = volume;
                if (volume >= 1) clearInterval(interval);
            }, 100);
        }

        // Función para el fade-out del sonido
        function fadeOutAudio(audio, duration) {
            let volume = audio.volume;
            const step = volume / (duration / 100); // Decremento del volumen
            const interval = setInterval(() => {
                volume = Math.max(volume - step, 0);
                audio.volume = volume;
                if (volume <= 0) {
                    audio.pause();
                    clearInterval(interval);
                }
            }, 100);
        }

        // Reproducción del sonido al detectar marcador
        document.querySelector('a-marker').addEventListener('markerFound', () => {
            fadeInAudio(windSound, 2000); // Fade-in de 2 segundos
            snow.setAttribute('visible', 'true');
            questionBox.setAttribute('visible', 'true');
            updateQuestion(); // Actualiza la primera pregunta
        });

        document.querySelector('a-marker').addEventListener('markerLost', () => {
            fadeOutAudio(windSound, 2000); // Fade-out de 2 segundos
            snow.setAttribute('visible', 'false');
            questionBox.setAttribute('visible', 'false');
        });

        // Actualizar pregunta y opciones
        function updateQuestion() {
            const current = questions[currentQuestion];
            questionText.setAttribute('value', current.question);
            answer1.setAttribute('text', 'value: ' + current.answers[0]);
            answer2.setAttribute('text', 'value: ' + current.answers[1]);
        }

        // Verificar respuestas al hacer clic
        document.querySelectorAll('.clickable').forEach(element => {
            element.addEventListener('click', (event) => {
                const selectedAnswer = event.target === answer1 ? 0 : 1;
                if (selectedAnswer === questions[currentQuestion].correct) {
                    currentQuestion++;
                    if (currentQuestion < questions.length) {
                        updateQuestion();
                    } else {
                        // Mostrar estampilla al finalizar
                        stamp.setAttribute('visible', 'true');
                        stamp.emit('show-stamp');
                        setTimeout(() => stamp.emit('fly-stamp'), 2000);
                        fadeOutAudio(windSound, 2000);
                        snow.setAttribute('visible', 'false');
                    }
                }
            });
        });
    </script>
</body>
</html>
